<html>
<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="https://js.arcgis.com/4.5/esri/css/main.css">
    <script src="https://js.arcgis.com/4.5"></script>
    <style>
    html,body,
    #viewDiv{
    	padding: 0;
    	margin: 0;
    	width: 100%;
    	height: 100%;
    }
    </style>
</head>
<body>
	<script>
		require(["esri/config","esri/request","esri/Basemap","esri/Map","esri/views/MapView","esri/layers/BaseTileLayer","dojo/domReady!"],function(esriConfig,esriRequest,Basemap,Map,MapView,BaseTileLayer){

			var MyCustomTileLayer = BaseTileLayer.createSubclass({
				    // properties of the custom tile layer
				    properties: {
				      urlTemplate: null
				    },

				   // override getTileUrl()
				   // generate the tile url for a given level, row and column
				   getTileUrl: function (level, row, col) {
				     return this.urlTemplate.replace("{level}", level).replace("{col}", col).replace("{row}", row);
				   },
				     // This method fetches tiles for the specified level and size.
		        // Override this method to process the data returned from the server.
		        fetchTile: function(level, row, col) {

		          // call getTileUrl() method to construct the URL to tiles
		          // for a given level, row and col provided by the LayerView
		          var url = this.getTileUrl(level, row, col);

		          // request for tiles based on the generated url
		          // set allowImageDataAccess to true to allow
		          // cross-domain access to create WebGL textures for 3D.
		          return esriRequest(url, {
		              responseType: "image",
		              allowImageDataAccess: true
		            })
		            .then(function(response) {
		              // when esri request resolves successfully
		              // get the image from the response
		              var image = response.data;
		              var width = this.tileInfo.size[0];
		              var height = this.tileInfo.size[0];

		              // create a canvas with 2D rendering context
		              var canvas = document.createElement("canvas");
		              var context = canvas.getContext("2d");
		              canvas.width = width;
		              canvas.height = height;

		              // Apply the tint color provided by
		              // by the application to the canvas
		              if (this.tint) {
		                // Get a CSS color string in rgba form
		                // representing the tint Color instance.
		                context.fillStyle = this.tint.toCss();
		                context.fillRect(0, 0, width, height);

		                // Applies "difference" blending operation between canvas
		                // and steman tiles. Difference blending operation subtracts
		                // the bottom layer (canvas) from the top layer (tiles) or the
		                // other way round to always get a positive value.
		                context.globalCompositeOperation = "difference";
		              }

		              // Draw the blended image onto the canvas.
		              context.drawImage(image, 0, 0, width, height);

		              return canvas;
		            }.bind(this));
		           }
				});

		   esriConfig.request.corsEnabledServers.push("http://t0.tianditu.com/","http://t1.tianditu.com/","http://t2.tianditu.com/","http://t3.tianditu.com/","http://t4.tianditu.com/","http://t5.tianditu.com/");
		   var tiandituVecLayer = new MyCustomTileLayer({
		   	  urlTemplate:"http://t0.tianditu.com/DataServer?T=vec_w&x={col}&y={row}&l={level}"
		   });
		   var tiandituCvaLayer = new MyCustomTileLayer({
		   	urlTemplate:"http://t1.tianditu.com/DataServer?T=cva_w&x={col}&y={row}&l={level}"
		   });
           var map = new Map({
              layers:[tiandituVecLayer,tiandituCvaLayer]
           });
           var view  = new MapView({
           	  container:"viewDiv",
           	  map:map,
           	  zoom:4,
           	  center:[115,33]
           });

		});

	</script>

	<div id="viewDiv"></div>
</body>
</html>
